!-----------------------------------------------------------------------------
! (C) Crown copyright 2025 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> Test the vertical linear interpolation kernel
module lfric2lfric_vertical_linear_interpolation_kernel_mod_test

  use constants_mod,                       only : r_def, i_def
  use get_unit_test_m3x3_q3x3x3_sizes_mod, only : get_w3_m3x3_q3x3x3_size
  use get_unit_test_m3x3_dofmap_mod,       only : get_w3_m3x3_dofmap

  use funit

  implicit none

  private
  public:: test_all

  contains

@Test
  subroutine test_all()
  
    use lfric2lfric_vertical_linear_interpolation_kernel_mod, only: lfric2lfric_vertical_linear_interpolation_kernel_code

    implicit none

    integer(kind=i_def)    :: nlayers
    integer(kind=i_def)    :: ncell
    integer(kind=i_def)               :: dim_space, dim_space_diff, nqp_h, nqp_v
    integer(kind=i_def), parameter    :: source_layers
    integer(kind=i_def), parameter    :: ndf_dest, ndf_source
    integer(kind=i_def), parameter    :: undf_dest, undf_source
    integer(kind=i_def), allocatable  :: map_dest(:,:)
    integer(kind=i_def), allocatable  :: map_source(:,:)
    real(kind=r_single), allocatable  :: destination_field(:)
    real(kind=r_single), allocatable  :: source_field(:)
    real(kind=r_single), allocatable  :: dest_heights(:)
    real(kind=r_single), allocatable  :: source_heights(:)

    nlayers  = 5_i_def
    source_layers = 4_i_def
    call get_w3_m3x3_q3x3x3_size( ndf_source, undf_source,           &
                                  ncell,                    &
                                  dim_space, dim_space_diff, &
                                  nqp_h, nqp_v,              &
                                  source_layers )

    call get_w3_m3x3_dofmap(map_source, 4_i_def)

    call get_w3_m3x3_q3x3x3_size( ndf_dest, undf_dest,           &
                                  ncell,                    &
                                  dim_space, dim_space_diff, &
                                  nqp_h, nqp_v,              &
                                  nlayers )
    call get_w3_m3x3_dofmap(map_dest, 5_i_def)

    ! allocate
    allocate(destination_field(undf_dest))
    allocate(source_field(undf_source))
    allocate(dest_heights(undf_dest))
    allocate(source_heights(undf_source))
    
    source_field = (/&
    (SHARKS_1A, SHARKS_2A, SHARKS_3A, SHARKS_4A),
    (SHARKS_1B, SHARKS_2B, SHARKS_3B, SHARKS_4B),
    (SHARKS_1C, SHARKS_2C, SHARKS_3C, SHARKS_4C),
    (0.5_r_def, 1.5_r_def, 2.5_r_def, 3.5_r_def),
    (1.0_r_def, 2.0_r_def, 3.0_r_def, 4.0_r_def),
    (1.5_r_def, 2.5_r_def, 3.5_r_def, 4.5_r_def),
    (SHARKS_1D, SHARKS_2D, SHARKS_3D, SHARKS_4D),
    (SHARKS_1E, SHARKS_2E, SHARKS_3E, SHARKS_4E),
    (SHARKS_1F, SHARKS_2F, SHARKS_3F, SHARKS_4F)
    /)
    source_heights = (/&
    (1.0_r_def, 2.0_r_def, 3.0_r_def, 4.0_r_def),
    (1.0_r_def, 2.0_r_def, 3.0_r_def, 4.0_r_def),
    (1.0_r_def, 2.0_r_def, 3.0_r_def, 4.0_r_def),
    (1.0_r_def, 2.0_r_def, 3.0_r_def, 4.0_r_def),
    (1.0_r_def, 2.0_r_def, 3.0_r_def, 4.0_r_def),
    (1.0_r_def, 2.0_r_def, 3.0_r_def, 4.0_r_def),
    (1.0_r_def, 2.0_r_def, 3.0_r_def, 4.0_r_def),
    (1.0_r_def, 2.0_r_def, 3.0_r_def, 4.0_r_def),
    (1.0_r_def, 2.0_r_def, 3.0_r_def, 4.0_r_def)    
    /)
    dest_heights = (/&
    (0.5_r_def, 1.5_r_def, 2.5_r_def, 3.5_r_def, 4.5_r_def),
    (0.5_r_def, 1.5_r_def, 2.5_r_def, 3.5_r_def, 4.5_r_def),
    (0.5_r_def, 1.5_r_def, 2.5_r_def, 3.5_r_def, 4.5_r_def),
    (0.5_r_def, 1.5_r_def, 2.5_r_def, 3.5_r_def, 4.5_r_def),
    (0.5_r_def, 1.5_r_def, 2.5_r_def, 3.5_r_def, 4.5_r_def),
    (0.5_r_def, 1.5_r_def, 2.5_r_def, 3.5_r_def, 4.5_r_def),
    (0.5_r_def, 1.5_r_def, 2.5_r_def, 3.5_r_def, 4.5_r_def),
    (0.5_r_def, 1.5_r_def, 2.5_r_def, 3.5_r_def, 4.5_r_def),
    (0.5_r_def, 1.5_r_def, 2.5_r_def, 3.5_r_def, 4.5_r_def),
    /)
